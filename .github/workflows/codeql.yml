name: "CodeQL"

on:
  workflow_dispatch:

jobs:
  analyze_backend:
    name: Analyze .NET
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: csharp

    - name: Use .NET 8
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
        source-url: https://api.nuget.org/v3/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.NUGET_AUTH_TOKEN}}

    - name: Create Nuget directory
      shell: pwsh
      run: |
        if (!(Test-Path -Path ".\.nuget" ))
        {
          New-Item -ItemType "directory" -Path ".\.nuget"
        }
        if (!(Test-Path -Path ".\.nuget\packages" ))
        {
          New-Item -ItemType "directory" -Path ".\.nuget\packages"
        }

    - name: Restore Nuget packages + Build
      run: ./build.ps1

    - name: Execute CodeQL analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

  analyze_frontend:
    name: Analyze Javascript + TypeScript
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: javascript-typescript

    - name: Use Node.js 16.x
      uses: actions/setup-node@v4
      with:
        node-version: 16
        check-latest: true

    - name: NPM Install + Build Cases UI
      run: |
        cd src/Indice.Features.Cases.App
        npm install --force
        npm run build:template
        
    - name: NPM Install + Build Admin UI
      run: |
        cd src/Indice.Features.Identity.AdminUI.App
        npm install --force
        npm run build:template
        
    - name: NPM Install + Build Messages UI
      run: |
        cd src/Indice.Features.Messages.App
        npm install --force
        npm run build:template
    
    - name: Execute CodeQL analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"
